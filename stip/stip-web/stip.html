<!DOCTYPE html>
<html lang="en">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />

    <link rel="stylesheet" href="css/bootstrap.css"/> 
    <link rel="stylesheet" href="css/starter-template.css"/>
    <link rel="stylesheet" href="css/bootstrap-toggle.css"/>
    <link rel="stylesheet" href="protopurity.css" type="text/css" media="all"/> 
    <link rel="stylesheet" href="lib/jquery-ui.min.css"/>
    <link rel="stylesheet" href="css/codemirror.css"/>
    <link rel="stylesheet" href="css/mdn-like.css"/>

    <title>STiP.js</title>
    <!-- Le javascript-->
    <!-- Jipda -->
    <script type="text/javascript" src="../lib/esprima.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/common.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/ast.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/agc.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lattice.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/abstLattice1-2.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/concLattice.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/countingStore.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/graph.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/jsCesk.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/concreteAg.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/tagAg.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/benv.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/object.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/jquery-ui-1.11.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/codemirror.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/hint/show-hint.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/hint/anyword-hint.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/d3.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/pdg/pdg.js"></script>

    <!--/end Jipda -->

    <script type="text/javascript" src="examples.js"></script>
    <script src="../lib/esprima.js"></script>
    <script src="../lib/falafel_esprima.js"></script>
    <script src="../lib/estraverse.js"></script>
    <script src="../lib/escope.js"></script>
    <script src="../lib/esrefactor.js"></script>
    <script src="../lib/json2.js"></script>
    <script src="../lib/beautifier.js"></script>
    <script src="lib/codemirror/codemirror.js"></script>
    <script src="lib/codemirror/javascript.js"></script>
    <script type="text/javascript" src="../lib/falafel.js"></script>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="http://yui.yahooapis.com/3.9.0/build/yui/yui-min.js"></script>
    <script src="lib/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-toggle.min.js"></script>
    <script src="js/prettify.js"></script>
    <script src="js/tab.js"></script>
    <script src="js/transition.js"></script>
    <script src="js/collapse.js"></script>
    <script type="text/javascript" src="../aux.js"></script>
    <script type="text/javascript" src="../handler-transform.js"></script>
	<script type="text/javascript" src="../handler-predefined.js"></script>
	<script type="text/javascript" src="../handler-generate.js"></script>
	<script type="text/javascript" src="../handler.js"></script>
    <script type="text/javascript" src="../PDG/edge.js"></script>
    <script type="text/javascript" src="../PDG/node.js"></script>
    <script type="text/javascript" src="../PDG/graph.js"></script>
    <script type="text/javascript" src="../jslibs.js"></script>
    <script type="text/javascript" src="../pre-analysis.js"></script>
    <script type="text/javascript" src="../hoist.js"></script>
    <script type="text/javascript" src="../annotations.js"></script>
    <script type="text/javascript" src="js/esprimatool.js"></script>
    <script type="text/javascript" src="lib/jslint.js"></script>
    <script type="text/javascript" src="js/jslinttool.js"></script>
    <script type="text/javascript" src="../exceptions.js"></script>
    <script type="text/javascript" src="../stip.js"></script>
    <script type="text/javascript" src="../placement/default_strategy.js"></script>
    <script type="text/javascript" src="../data-annotations.js"></script>
    <script type="text/javascript" src="../InterferenceAnalysis.js"></script>
    <script type="text/javascript" src="../transpiler/CPS_transform.js"></script>
    <script type="text/javascript" src="../transpiler/Promise_transform.js"></script>
    <script type="text/javascript" src="../transpiler/JS_parse.js"></script>
    <script type="text/javascript" src="../transpiler/Meteor_parse.js"></script>
    <script type="text/javascript" src="../transpiler/Node_parse.js"></script>
    <script type="text/javascript" src="../transpiler/JSify.js"></script>
    <script type="text/javascript" src="../transpiler/Meteorify.js"></script>
    <script type="text/javascript" src="../transpiler/Nodeify.js"></script>
    <script type="text/javascript" src="../transpiler/slice.js"></script>
    <script type="text/javascript" src="../transpiler/transpiler.js"></script>
    <script type="text/javascript" src="../lib/esutils.js"></script>
    <script type="text/javascript" src="../lib/esutils_code.js"></script>
    <script type="text/javascript" src="../lib/escodegen.js"></script>
    <script type="text/javascript" src="PDGgraph.js"></script>
    <script type="text/javascript" src="pdgGraphs.js"></script>
    <script type="text/javascript" src="componentGraph.js"></script>
    <script type="text/javascript" src="lib/viz.js"></script>

    <script type="text/javascript">

    // define print method for JIPDA
    var print = function () { console.log(Array.prototype.slice.call(arguments).join(" ")) },       
        editor, slicededitor, result, PDGg, clientprogram, serverprogram, assumes, shared, asyncs;

    function doIt () {
        try {

            $("#graph").empty();
            $("#error").empty();

            var src = editor.getValue(),
                // First parse and create again via escodegen
                ast = Ast.createAst(src, {loc:true, owningComments: true, comment: true});
            ast = Hoist.hoist(ast, function (node) {
                    return Aux.isBlockStm(node) && 
                        (Comments.isClientorServerAnnotated(node) || Comments.isSliceAnnotated(node) || 
                            (node.leadingComment && Comments.isBlockingAnnotated(node.leadingComment)));
                });

            Handler.init();
            /* Pre analysis step (uses falafel, so does not work on AST but string representation */
            var preanalysis = pre_analyse(ast, {callbacks: [], identifiers: []});
            src = escodegen.generate(preanalysis.ast);
            console.log(src);
            assumes = preanalysis.assumes;
            shared  = preanalysis.shared;
            asyncs  = preanalysis.asyncs;
            $("#graph").empty();
            graphs = new Stip.Graphs(preanalysis.ast, src, preanalysis.primitives);
            Stip.start(graphs);

            /* Placement Strategy */
            graphs.PDG.distribute(DefaultPlacementStrategy);
            /* Check Data Annotations */
            DataAnnotations.checkDataAnnotations(graphs.PDG);

            /* Draw graphs */
            var g = createPDGGraph(graphs.PDG, assumes);
            drawPDGGraph(g[0], g[1], g[2]);
          
            cy = createComponentGraph(graphs.PDG);
            createOfflineReport(graphs);

            return graphs; 
        } catch (err) {
            console.log(err.message);
            $("#error").empty();
            $("#error").append(err.name + " " + err.message + "<br>" + err.stack);
        }
      }

      function printCode () {
            var concatCode = function (code) {
                slicededitor.setValue(slicededitor.getValue() +
                    code + "\n")
            }
            slicededitor.setValue('');
            if ($("#includeclient").prop('checked') && $("#includesetup").prop('checked')) {
                concatCode("/* CLIENT */"); 
                if (shared) concatCode(escodegen.generate(shared)); 
                concatCode(escodegen.generate(clientprogram.program)) ;
            }
            else if ($("#includeclient").prop('checked')) {
                concatCode("/* CLIENT */");
                if (shared) concatCode(escodegen.generate(shared)) ;
                concatCode(escodegen.generate(clientprogram.nosetup));
            }
            else if ($("#includesetup").prop('checked')) {
                concatCode("/* CLIENT */");
                if (shared) concatCode(escodegen.generate(shared)); 
                concatCode(escodegen.generate(clientprogram.setup));
            }
            if ($("#includeserver").prop('checked') && $("#includesetup").prop('checked')) {
                concatCode("/* SERVER */");
                if (shared) concatCode(escodegen.generate(shared)); 
                concatCode(escodegen.generate(serverprogram.program));
            }
            else if ($("#includeserver").prop('checked')) {
                concatCode("/* SERVER */");
                if (shared) concatCode(escodegen.generate(shared)); 
                concatCode(escodegen.generate(serverprogram.nosetup));
            }
            else if ($("#includesetup").prop('checked')) {
                concatCode("/* SERVER */");
                if (shared) concatCode(escodegen.generate(shared)); 
                concatCode(escodegen.generate(serverprogram.setup));
            }
      }

      function split () { 
        try {
            var graphs  = doIt(),
                PDG     = graphs.PDG;
            PDGg = graphs;
            slicededitor.setValue("");
            //$('.collapse').collapse();
            var slicedc      = PDG.sliceTier(DNODES.CLIENT),
                sliceds      = PDG.sliceTier(DNODES.SERVER),
                sortedc      = slicedc.slice(0),
                sorteds      = sliceds.slice(0),
                removes      = [],
                assumesnames = assumes.map(function (ass) {
                                    if (ass.id)
                                        return ass.id.name.trim();
                                    else
                                        return ass.declarations[0].id.name.trim()}),
                program,
                splitCode = function (nodes, option) {
                    nodes.sort(function (n1, n2) {
                        return n1.cnt - n2.cnt;
                    })
                    var target   = $('#target').val(),
                        asyncomm = $('#asyncomm').val(),
                        program  = CodeGenerator.transpile(nodes, {target: target, tier: option, asynccomm : asyncomm}, graphs.AST);
                    return program;
                },
                remove    = function (node) {
                    sorteds = sorteds.remove(node);
                    sortedc = sortedc.remove(node);
                    if (node.isEntryNode) {
                        var params = node.getFormalIn().concat(node.getFormalOut()),
                        body   = node.getBody();
                        params.map(function (param) {sorteds = sorteds.remove(param); sortedc = sortedc.remove(param)});
                        body.map(function (bodynode) {remove(bodynode); });
                    }
                    else if (node.isStatementNode) {
                        node.getOutEdges(EDGES.CONTROL)
                            .map(function (e) {remove(e.to)});
                        node.getOutEdges(EDGES.DATA)
                            .filter(function (e) {
                                return e.to.isObjectEntry ||
                                        e.to.isEntryNode})
                            .map(function (e) {
                                remove(e.to);});
                    }
                    else if (node.isObjectEntry) {
                        node.getOutEdges(EDGES.OBJMEMBER).map(function (e) {
                            remove(e.to)
                        });
                    }
                };
            sortedc.sort(function (n1, n2) { 
                return n1.cnt - n2.cnt;
            }); 
            sorteds.sort(function (n1, n2) { 
                return n1.cnt - n2.cnt;
            });
            /* Filter out nodes that were added by the assumes statement, or default global variables */
            sortedc = sortedc.filter(function (pdgnode) {
                if (pdgnode.parsenode)
                    if (Aux.isFunDecl(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.id.name) > -1) {
                        removes = removes.concat(pdgnode);
                        return false;
                    } 
                    else if (Aux.isVarDeclarator(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.id.name) > -1) {
                        removes = removes.concat(pdgnode);
                        return false;
                    }
                    else
                        return true;
                else
                    return true;
            });
            sorteds = sorteds.filter(function (pdgnode) {
                if (pdgnode.parsenode)
                    if (Aux.isFunDecl(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.id.name) > -1) {
                        removes = removes.concat(pdgnode)
                        return false
                    } 
                    else if (Aux.isVarDeclarator(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.id.name) > -1) {
                        removes = removes.concat(pdgnode);
                        return false;
                    }
                    else
                        return true
                else
                    return true
            });
            removes.map(function (node) {
               remove(node);
            });
            sortedc = graphs.PDG.getAllNodes(function (n) {return n.parsenode && n.parsenode.leadingComment && Comments.isCopyAnnotated(n.parsenode.leadingComment)}).concat(sortedc);
            clientprogram =  splitCode(sortedc, "client");
            serverprogram = splitCode(sorteds, "server");
            printCode();
        } catch (err) {
            console.log(err.stack);
            $("#error").append(err.message);
        }
      }


      function cpstransform () {
        try {
            slicededitor.setValue("");
            var graphs  = doIt(),
                PDG     = graphs.PDG,
                nodes   = PDG.getAllNodes(),
                assumesnames = assumes.map(function (ass) {
                                    if (ass.id)
                                        return ass.id.name.trim();
                                    else
                                        return ass.declarations[0].id.name.trim()}),
                removes = [],
                remove    = function (node) {
                    nodes = nodes.remove(node);
                    if (node.isEntryNode) {
                        var params = node.getFormalIn().concat(node.getFormalOut()),
                        body   = node.getBody();
                        params.map(function (param) {nodes = nodes.remove(param)});
                        body.map(function (bodynode) { remove(bodynode)}); //nodes = nodes.remove(bodynode);});
                    }
                    else if (node.isStatementNode) {
                        node.getOutEdges(EDGES.CONTROL)
                            .map(function (e) {remove(e.to)});
                        node.getOutEdges(EDGES.DATA)
                            .filter(function (e) {
                                return e.to.isObjectEntry ||
                                    e.to.isEntryNode;})
                            .map(function (e) {
                                remove(e.to)});
                    }
                    else if (node.isObjectEntry) {
                        node.getOutEdges(EDGES.OBJMEMBER).map(function (e) {
                            remove(e.to)
                        });
                    }
                },
                program;

            nodes.map(function (pdgnode) {
                if (pdgnode.parsenode)
                    if (Aux.isFunDecl(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.id.name) > -1) {
                        removes = removes.concat(pdgnode);
                        return false
                    } 
                    else if (Aux.isVarDeclarator(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.id.name) > -1) {
                        removes = removes.concat(pdgnode);
                        return false;
                    }
                    else
                        return true
                else
                    return true
            });
            removes.map(function (node) {
               remove(node);
            });
            program = CodeGenerator.transpile(nodes, {target: 'normal', cps : true}, graphs.AST);
            slicededitor.setValue(escodegen.generate(program.program));
        } catch (err) {
            console.log(err.stack);
            $("#error").append(err.message);
        }
      }


      $(function () {

        editor.setValue(Examples.tiersplitexs[0]);
        editor.setCursor(0,0);
        editor.focus();
      })

      function fillSnippets(){
        var list = document.getElementById('snippets'),
            split = 'Tier-splitting',
            normal = 'JavaScript',
            cont   = 'Continuations',
            head = document.createElement('li'),
            i = 0;
        head.appendChild(document.createTextNode(split));
        list.appendChild(head);
        Examples.tiersplittxt.map(function (txt) {
            var li = document.createElement('li'),
                a = document.createElement('a');
            a.appendChild(document.createTextNode(txt));
            a.setAttribute('data-value', i);
            a.setAttribute('role', 'menuitem')
            i++;
            li.appendChild(a);
            li.setAttribute('role', 'presentation')
            list.appendChild(li);
        });
        head = document.createElement('li');
        head.appendChild(document.createTextNode(normal));
        list.appendChild(head);
        Examples.slicetxt.map(function (txt) {
            var li = document.createElement('li'),
                a = document.createElement('a');
            a.appendChild(document.createTextNode(txt));
            a.setAttribute('data-value', i);
            i++;
            li.appendChild(a);
            list.appendChild(li);
        });
        head = document.createElement('li');
        head.appendChild(document.createTextNode(cont));
        list.appendChild(head);
        Examples.continuationstxt.map(function (txt) {
            var li = document.createElement('li'),
                a = document.createElement('a');
            a.appendChild(document.createTextNode(txt));
            a.setAttribute('data-value', i);
            i++;
            li.appendChild(a);
            list.appendChild(li);
        });
      };

      function createOfflineReport (graphs) {
        var PDG = graphs.PDG;
        var clientfs = [];
        var serverfs = [];
        var clientperc = 0;
        var serverperc = 0;
        PDG.getFunctionalityNodes().map(function (f) {
            if (f.tier === DNODES.SERVER) 
                serverfs.push(f.ftype)
            if (f.tier === DNODES.CLIENT)
                clientfs.push(f.ftype)
        });
        console.log("CLIENT FUNCTIONALITIES");
        clientfs.map(function (r) {console.log(r)});
        console.log("SERVER FUNCTIONALITIES");
        serverfs.map(function (r) {console.log(r)});
        clientperc = clientfs.length / (clientfs.length + serverfs.length);
        serverperc = serverfs.length / (clientfs.length + serverfs.length);

        $("#clientbar").width(clientperc*100+'%');
        $("#serverbar").width(serverperc*100+'%');
        $("#functionalities").empty();
        graphs.PDG.getFunctionalityNodes().map(function (functionality) {
            createFunctionality(functionality);
        })

        
        function createFunctionality(funcNode) {
            var dataCntC = funcNode.countEdgeTypeFilter(EDGES.REMOTED, function (f) {return f.tier == DNODES.CLIENT}, -1);
            var dataCntS = funcNode.countEdgeTypeFilter(EDGES.REMOTED, function (f) {return f.tier == DNODES.SERVER}, -1);
            var callCntC = funcNode.countEdgeTypeFilter(EDGES.REMOTEC, function (f) {return f.tier == DNODES.CLIENT});
            var callCntS = funcNode.countEdgeTypeFilter(EDGES.REMOTEC, function (f) {return f.tier == DNODES.SERVER});
            var item = $("<a class='row' style='text-align:center;'></a>").addClass("list-group-item");
            var label = (funcNode.tier == DNODES.CLIENT) ? " <span class='label label-info'>client</span>" : " <span class='label label-warning'>server</span>";
            item.append("<h4 class='list-group-item-heading'>"+ funcNode.ftype + label +" </h4");
            var divGraphD = $("<div class='col-sm-6' style='height: 130px;'></div");
            var divGraphC = $("<div class='col-sm-6' style='height: 130px;'></div");
            var divText = $("<div class='col-sm-6'></div>");
            var divData = $("<div class='well' 'style='text-align:left; padding: 5px;'><h5>DATA DEPENDENCIES</h5></div>");
            var divCall = $("<div class='well' style='text-align:left; padding: 5px;'><h5>CALL DEPENDENCIES</h5></div>");
            divData.append('<p> > Client: '+ dataCntC +'</p>');
            divData.append('<p> > Server: '+ dataCntS +'</p>');
            divCall.append('<p> > Client: '+ callCntC +'</p>');
            divCall.append('<p> > Server: '+ callCntS +'</p>');

            divText.append(divData).append(divCall);
            if (funcNode.tier == DNODES.CLIENT)
                createGauge((dataCntC / (dataCntS + dataCntC))*100,'Data', divGraphD);
            else
                createGauge(0, 'Data', divGraphD);

            if (funcNode.tier == DNODES.CLIENT)
                createGauge((callCntC / (callCntS + callCntC))*100,'Call', divGraphC);
            else {
                createGauge(0, 'Call', divGraphC);
            }

            item.append(divText).append(divGraphD).append(divGraphC);
            $("#functionalities").append(item);
            $(window).trigger('resize');
            window.dispatchEvent(new Event('resize'));
        }

        function createGauge (percentage, title, div) {
               var gaugeOptions = {

                chart: {
                    type: 'solidgauge'
                },

                title: null,

                pane: {
                    center: ['50%', '55%'],
                    size: '80%',
                    startAngle: -90,
                    endAngle: 90,
                    background: {
                        backgroundColor: '#EEE',
                        innerRadius: '60%',
                        outerRadius: '100%',
                        shape: 'arc'
                    }
                },

                tooltip: {
                    enabled: false
                },

                // the value axis
                yAxis: {
                    stops: [
                        [0.1, '#DF5353'], // red
                        [0.3, '#DDDF0D'], // yellow
                        [0.6, '#55BF3B'] // green
                    ],
                    lineWidth: 0,
                    minorTickInterval: null,
                    tickPixelInterval: 400,
                    tickWidth: 0,
                    title: {
                        y: -35
                    },
                    labels: {
                        y: 15
                    }
                },

                plotOptions: {
                    solidgauge: {
                        dataLabels: {
                            y: -25,
                            borderWidth: 0,
                            useHTML: true
                        }
                    }
                }
            };

            // The speed gauge
            div.highcharts(Highcharts.merge(gaugeOptions, {
                yAxis: {
                    min: 0,
                    max: 100,
                    title: {
                        text: title
                    }
                },

                credits: {
                    enabled: false
                },

                series: [{
                    name: title,
                    data: [Math.round(percentage)],
                    dataLabels: {
                        format: '<div style="text-align:center"><span style="font-size:18px;color:' +
                            ((Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black') + '">{y}</span><br/></div>'
                    },
                   
                }]

            }));

        }


      }

  </script>
</head>

<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">         
                    <span class="sr-only">Toggle navigation</span>          
                    <span class="icon-bar"></span>          
                    <span class="icon-bar"></span>          
                    <span class="icon-bar"></span>        
                </button>
                <img src="imgs/stip-white.png" style="height:55px;">
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="stip.html">Home</a></li>
                    <li><a href="howto.html">How to</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div> <!--/.container -->
    </div> <!-- /.navbar -->
    <div class="container theme-showcase" role="main">
        <div class="jumbotron" >
            <div class="row" arylw="table-layout: fixed;">
                <div class="col-md-4">
                    <img src="imgs/stip.png"/>
                </div>
                <div class="col-md-6" style="display: table !important; height: 170px;">
                    <div style= "display: table-cell; vertical-align:middle;">
                        <p class="lead">Slicing Tierless Programs in JavaScript </p>
                        <p class="small"> This is a first prototype of the tier splitting tool Stip.js. 
                        (tested on Chrome and Firefox)</p>
                    </div>
                </div>
            </div>
        </div> <!-- /.jumbotron -->
        <div id= "code">
            <div class="well row" style="margin-left: 0px; margin-right: 0px; margin-top: 5px; margin-bottom: 5px;">
                <div class="col-md-6" id="leftcode"> 
                    <div class="row">
                        <h4 style="float:left;">Your JavaScript code:</h4>
                        <div class="dropdown" style="float: right; margin-right:20px">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" 
                                    id="dropdownSnippets" style="float:right;">
                                Snippets
                                <span class="caret"></span>
                            </button>
                            <ul id="snippets" aria-labelledby="dropdownSnippets" class="dropdown-menu" role="menu"></ul>
                        </div>
                    </div>
                    <!--<div id="editor" style="height: 350px; width:100%;"></div>-->
                    <textarea id="editor" name="editor"></textarea>
                </div>
                <div class="col-md-6" id="rightcode"> 
                    <div class="row">
                        <h4 style="float:left;">Sliced code:</h4>
                        <div class="form-inline" id="editordashboard" style="float:right; margin:4px;">
                           <div class="checkbox">
                                <input data-toggle="toggle" data-size="small" type="checkbox" id="includeclient" data-on="client" data-off="client" checked>
                            </div>
                            <div class="checkbox">
                                <input data-toggle="toggle" data-size="small" type="checkbox" id="includeserver" data-on="server" data-off="server" checked>
                            </div>
                            <div class="checkbox">
                                <input data-toggle="toggle" data-size="small" type="checkbox" id="includesetup" data-on="setup" data-off="setup">
                            </div>
                        </div>
                    </div>
                   <!--<div class="row" id="slicededitor" style="height: 350px;"></div>-->
                   <textarea id="slicededitor" name="slicededitor"></textarea>
                </div>
            </div>

            <div class="well">

            <div class="container">
                <div id="manip" style="margin-top: 1%;">
                    <button id="eval" name="eval" onClick="doIt()" class="btn btn-success" 
                            style="float: left; margin-right: 10px">Eval</button> 
                    <p style="float: left; margin-right: 10px; padding-top:1%"> or </p>
                    <button id="cpstransform" name="cpstransform" onClick="cpstransform()" class="btn btn-success" 
                            style="float: left; margin-right: 10px">Transform CPS</button> 
                    <p style="float: left; margin-right: 10px; padding-top:1%"> or </p>
                    <button id="split" name="split"  class="btn btn-success" 
                            data-toggle="collapse" data-target="#splitconfig" aria-expanded="false"
                            aria-controls="splitconfig"
                            style="float: left; margin-right: 10px">Tier split</button> 
                    <div class="collapse" id="splitconfig" style="float:left">
                        <div class="well">
    
                                <div class="form-group">
                                    <label for="target">Target</label>
                                    <select class="form-control" id="target">
                                        <option>node.js</option>
                                        <option>meteor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="asyncomm">Asynchronous Communication</label>
                                    <select class="form-control" id="asyncomm">
                                        <option>callbacks</option>
                                        <option>promises</option>
                                    </select>
                                </div>
                              <button onClick="split()" class="btn btn-default">Split!</button>
                        </div>
                    </div>
                </div> <!-- /.manip -->
                <!-- <p id="error" style="float:left;"></p> -->
            </div> <!-- /.container -->
            
             <div id="error" style="color: #ff0606;"> </div>


            <!-- Stip -->

          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#report" aria-controls="report" role="tab" data-toggle="tab">Offline Report</a></li>
            <li role="presentation"><a href="#fdg" aria-controls="fdg" role="tab" data-toggle="tab">Web Slice Graph</a></li>
            <li role="presentation"><a href="#pdg" aria-controls="pdg" role="tab" data-toggle="tab">Program Dependence Graph</a></li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content" style="min-height: 400px;">
            <div role="tabpanel" class="tab-pane active" id="report">
                <div class="report-well">
                    <h3>Web slice distribution</h3>
                    <div class="progress">
                          <div id="clientbar" class="progress-bar progress-bar-info progress-bar-striped" role="progressbar" style="width: 0%">
                            <span>CLIENT</span>
                          </div>
                          <div id="serverbar" class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar" style="width: 0%">
                            <span>SERVER</span>
                          </div>
                        </div>
                    <h3>Detailed report</h3>
                    <div id="functionalities" class="list-group"></div>
                </div>

            </div> <!-- /report -->
            <div role="tabpanel" class="tab-pane" id="fdg">
                <div id="componentgraph" style="height:400px;" ></div>
            </div>
            <div role="tabpanel" class="tab-pane" id="pdg">
                
                 <div id="graphcont">
                    <div id="pdggraph">

                        <div class="fixed tooltip"></div>
                    </div>
                </div>

            </div>
          </div>


                    
    
            </div> <!-- ./well -->
        </div>  <!-- ./code -->     
    </div> <!-- ./main container -->


    </body>
    <script type="text/javascript">
        var keymap = {
            "Ctrl-S" : function (cm) {
                split();
            },
            "Ctrl-E" : function (cm) {
                doIt();
            },
            "Ctr-K" : function (cm) {
                cpstransform();
            },
            "Cmd-S" : function (cm) {
                split();
            },
            "Cmd-E" : function (cm) {
                doIt();
            },
            "Cmd-K" : function (cm) {
                cpstransform();
            }
        };

        editor= CodeMirror(function (e) {
            var txt = document.getElementById("editor");
            txt.parentNode.replaceChild(e, txt);
        }, {
            lineNumbers: true,
            styleActiveLine: true,
            matchBrackets : true,
            theme: "mdn-like"
        });
        editor.addKeyMap(keymap);
        $(editor.getWrapperElement()).resizable({
            resize: function() {
                editor.setSize($(this).width() , $(this).height());
                editor.refresh();
            }
        });
        $(editor.getWrapperElement()).on('dblclick', function () {
            $("#rightcode").toggle();
            if ($("#rightcode").is(":visible")) {
                editor.setSize($("#code").width() / 2-50 , $(this).height());
            } else {
                editor.setSize($("#code").width()- 50, $(this).height());
                
            }
            editor.refresh();
        });
        slicededitor= CodeMirror(function (e) {
            var txt = document.getElementById("slicededitor");
            txt.parentNode.replaceChild(e, txt);
        }, {
            lineNumbers: true,
            styleActiveLine: true,
            matchBrackets : true,
            theme: "mdn-like"
        });
        $(slicededitor.getWrapperElement()).resizable({
            resize: function() {
                slicededitor.setSize($(this).width(), $(this).height());
                slicededitor.refresh();
            }
        });
        $(slicededitor.getWrapperElement()).on('dblclick', function () {
            $("#leftcode").toggle();
            if ($("#leftcode").is(":visible")) {
                slicededitor.setSize($("#code").width() / 2 - 50, $(this).height());
                
            } else {
                slicededitor.setSize($("#code").width()- 50, $(this).height());
            }
            slicededitor.refresh();
        })


        fillSnippets();
        $(".dropdown-menu li a").click(function () {
                var value = $(this).data('value'),
                    nr_splits = Examples.tiersplitexs.length,
                    nr_splits2 = Examples.sliceexs.length,
                    text = '';
                if(value < nr_splits) 
                    text = Examples.tiersplitexs[value];
                else if (value < (nr_splits + nr_splits2))
                    text = Examples.sliceexs[value - nr_splits];
                else 
                    text = Examples.contexs[value - (nr_splits + nr_splits2)]
                editor.setValue(text);
                editor.setCursor(0,0);
                editor.focus();
        });
        $("#includeclient").change(function () {
            printCode();
        });
        $("#includeserver").change(function () {
            printCode();
        });
        $("#includesetup").change(function () {
            printCode();
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("href");
            if (target == "#fdg") {
                cy.resize();
                cy.layout({name: 'cose'});
            }

        })


        

    </script>

    <script type="text/javascript" src="lib/dagre-d3.js"></script>
    <script type="text/javascript" src="lib/cytoscape.js"></script>
    <script type="text/javascript" src="js/highcharts.js"></script>
    <script type="text/javascript" src="js/highcharts-more.js"></script>
    <script type="text/javascript" src="js/modules/solid-gauge.js"></script>

    </html>

